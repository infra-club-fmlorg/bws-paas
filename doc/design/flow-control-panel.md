# 管理画面/コントロールパネルの動作/データフロー

## ユーザ情報

以下
```
　ユーザ bibi
　アプリ portal
```
の場合を例にとります。

サービス仕様として、利用可能な文字列に次の制限をかけます。
- ここで使ってよい文字列は、半角英数字および- (Perlの正規表現で書くと [\w\-]+ ) の組み合わせに制限します
- 大文字小文字は区別しません(内部的には、すべて小文字に変換して処理します。ちなみに、これは DNS の仕様から来る制限です)


## 管理画面で出来ること

ユーザはブラウザで管理画面(いわゆるコントロールパネル、通称コンパネ)のURLをクリックします。
コンパネにある機能は次の２つだけです
1. 認証機能
    - 認証後、コンパネの画面にアクセスできます
    - 認証の設定は nginx で行うので、アプリケーション側に認証機能は不要です
1. ユーザはアプリをアップロードできます
    - ここ(アップロードされてきたデータをファイルに保存する動作)を担当するソフトウエアを開発する必要があります

管理画面の URL は未定ですが、こんな感じ?(要検討)

    https://secure.niij.fml.org/paas/


## 内部動作

### フロントのnginxがうけとめる

ブラウザからの通信(HTTPS)はnginxが受け止めます。

nginx は、
上の URL (secure.niij.fml.org/paas)をみて、
この通信(HTTPもしくはHTTPS)をコンパネのサーバ(コンテナ, 例: paas-admin)へ中継します。
なお、この動作はリバースプロキシ(revserse proxy)と呼ばれます。

　例:
     サーバ名 		paas-admin
     ポート番号		80/tcp

このサーバの実体は docker コンテナで、そのサーバ名が paas-admin です。
(つまり、仮想ユーザ paas のアプリ admin としています。そのため仮想ユーザ paas は予約語とし、一般ユーザは利用不可とします)。
このコンテナはGo言語で開発しようとしています

あらかじめ、
nginx 設定ファイル(例: /etc/nginx/conf.d/bws-paas-app.conf)に、
次の動作をするよう仕込んでおきます。
設定は変動しません。
初回、設定すれば、そのままです
- URLが secure.niij.fml.org/paas の場合 pass-admin コンテナへ中継(リバースプロキシ)


### paas-admin に期待されている動作

- アップロードされてきたデータを bws01 のストレージ上にファイルとして保存
- ファイル名に日付をつける
- 次のスクリプトに渡すときには確実にファイルが保存されたことが保証されていること
    1. まず「queue/tmp/ひづけ.tmp 」といった一時ファイルにデータを保存する
    1. ファイルサイズが正しい(HTTPヘッダのサイズと同じ)ことを確認
    1. (できればチェックサムも確認してほしい)
        - 注: 書き込んでいる途中にとったチェックサムとファイルを再読み込みした時のチェックサムを比較する。
          ローカルストレージの場合(キャッシュが使われるはずだから)ほぼ意味はないが、
          将来ネットワークストレージへ拡張した場合まで想定しておく。
          OSを信じないと何もできないが、だからといってOSを信じてはいけない。
          0.01%でも誤動作することはあるので、そういう事態を想定したコーディングをすること
    1. 確実に保存されたことを確認後、はじめて queue/incoming/ へ移動させる
- 次の処理をするスクリプトは queue/incoming/ を定期的に検査して新しいファイルが現れるのを待っている想定


### その後の処理(Bourneシェルスクリプト, 担当:深町 -> 土田)

(そのうち書く)

- 担当変更にともない、開発はシェルからGo言語へ変更


### コンテナの起動(担当:深町 -> 土田)

(そのうち書く)

- 担当変更にともない、開発はシェルからGo言語へ変更


### DNSの設定(fml.orgのサーバ群, 担当:???,深町)

1. コントロールパネル側でnamed用のゾーンファイルを生成する(bws側のTODO)
1. fml.orgのDNSサーバは、そのゾーンファイルを定期的に転送しnamedが読みこむ
   (この仕組みをしこむTODOは深町担当;
    DNSサーバはfml.org管理者でないと操作できないので、ここは担当変更不可)
1. (将来的にはniij.fml.orgゾーンは別のDNSサーバ群がのぞましい)
   ... そのサブドメインごと権限をniij.fml.orgへ移譲(delegatge)したい
