# 全体の動作/データフロー (アプリ編)

注:
別途、[管理画面(コントロールパネル)編の説明](flow-control-panel.md)があり、
そちらのほうがサーバの生々しい動作の話になります


## ユーザ情報

以下
```
　ユーザ bibi
　アプリ portal
```
の場合を例にとります。

サービス仕様として、利用可能な文字列に次の制限をかけます。
- ここで使ってよい文字列は、半角英数字および- (Perlの正規表現で書くと [\w\-]+ ) の組み合わせに制限します
    - [検討] アプリ名には拡張子がつくかもしれないので`.`も入れろ? e.g. www.go www.jar
- 大文字小文字は区別しません(内部的には、すべて小文字に変換して処理します。ちなみに、これは DNS の仕様から来る制限です)


## ユーザからみえる PaaS サービスとは?

### ブラウザでURLをクリック

ユーザはブラウザでURLをクリックします。
クリックするべきURL は、管理画面でアプリをアップロードした時(後述)に指定されたURLとなります。

いまの場合あたえられる URL は次のものになります

    https://bibi-portal.pass.niij.fml.org/


## 内部動作

### フロントのnginxがうけとめる

ブラウザからの通信(HTTPS)はnginxが受け止めます。

nginx は、
上の URL (bibi-portal.pass.niij.fml.org)から bibi-portal という部分(文字列)を取り出し、
この通信(HTTPもしくはHTTPS)を次のサーバへ中継します。
なお、この動作はリバースプロキシ(revserse proxy)と呼ばれます。

     サーバ名 		bibi-portal
     ポート番号		80/tcp

なお、動作しているサーバの実体は docker コンテナで、そのサーバ名が bibi-portal です。

事前に nginx 設定ファイル(例: /etc/nginx/conf.d/bws-paas-app.conf)に、次の動作をするよう仕込んでおきます。
設定は変動しません。初回、設定すれば、そのままです
- URLから該当する文字列(サーバ名=コンテナ名)を抜き出す(PCREの正規表現で行います)
- docker コンテナへ中継する(リバースプロキシ)


### アプリの実体(docker コンテナ bibi-portal)

ユーザはアプリを一つのウエブサーバ(listen するポートは 80/tcp)として作ってくる想定(これがサービス仕様)です。

ユーザのアプリを動かしているサーバの実体は docker コンテナです。
管理画面でアプリをアップロードした後、
管理システムが自動的に docker コンテナを起動します。
コンテナ名(つまりサーバ名)は、
有無をいわさず bibi-portal になります(これがサービス仕様です)。

1. bibi-portal コンテナは80/tcp ポートで通信(HTTP)を受け付けてください
(ブラウザ -> nginx -> bibi-portal)。
1. サーバからの返事は逆順です。
コンテナからの返事を nginx が中継してブラウザへ送り返しています
(ブラウザ <- nginx <- bibi-portal)。
